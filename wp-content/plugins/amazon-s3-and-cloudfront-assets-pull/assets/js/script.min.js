!function(a,b){function c(c){return c=_.isObject(c)?c:{},a.post(ajaxurl,_.extend({},c,{action:b.actions.check_assets_domain,_ajax_nonce:b.nonces.check_assets_domain,domain:k.val()}))}function d(b){var d=a.Deferred(),e=c(b),f=i.find(".as3cf-verify-domain").attr("check-result","").addClass("checking");return setTimeout(function(){d.resolve()},1500),a.when(e,d).done(function(a){var b=a[0];f.removeClass("checking").addClass("has-checked").attr("check-result",!!b.success+0),_.isObject(b.data)&&(f.find('[data-as3cf-bind="checked_domain"]').text(b.data.domain),f.find('[data-as3cf-bind="last_checked_at"]').text(b.data.last_checked_at),f.find('[data-as3cf-bind="check_message"]').text(b.data.message),b.data.more_info?f.find('[data-as3cf-bind-href="more_info"]').attr("href",b.data.more_info).show():f.find('[data-as3cf-bind-href="more_info"]').hide())}),e}function e(a){return!(!_.isString(a)||a.match(/[^a-z0-9-\.]/i)||!a.match(/^[a-z0-9].*[a-z0-9]$/i))}function f(a){var b,c;document.body.createTextRange?(b=document.body.createTextRange(),b.moveToElementText(a),b.select()):window.getSelection&&(c=window.getSelection(),b=document.createRange(),b.selectNodeContents(a),c.removeAllRanges(),c.addRange(b))}var g,h=a(document),i=a("#tab-assets_pull"),j=i.find(".as3cf-settings-form"),k=j.find('input[name="domain"]'),l=b.settings.domain||"",m={},n=_.once(function(){h.trigger("as3cf.assetsPull.init")}),o=function(b){this.slug=b,this.$el=a('<div class="as3cf-setup-wizard"></div>').data("wizard",this),this.$imageFrame=a('<div class="as3cf-image-frame"><img></div>'),this.currentStep=null,this.steps=_([])};o.prototype.init=function(){this.initSteps(b.wizard[this.slug].steps),this.initDom(),this.bindToDataActions()};var p=function(a,b){this.data=a,this.id=a.id,this.collection=b};p.prototype.initEl=function(){this.index=this.collection.indexOf(this),this.nextStep=this.collection.value()[this.index+1],this.prevStep=this.collection.value()[this.index-1],this.total=this.collection.size()-1;var b=a('<div class="as3cf-wizard-step-body"></div>').html(this.data.html);return this.$el=a('<div class="as3cf-wizard-step"></div>').append(b).attr("data-wizard-step",this.data.id).append(this.generateControls()),this.isOverview()?this.$el.addClass("as3cf-wizard-step-overview"):this.isLast()&&this.$el.addClass("as3cf-wizard-step-last"),this.$el},p.prototype.isOverview=function(){return 0===this.index},p.prototype.isLast=function(){return this===this.collection.last()},p.prototype.generateControls=function(){var c=a('<div class="as3cf-wizard-controls"></div>'),d=a('<div class="as3cf-wizard-control-row as3cf-wizard-control-row-primary"></div>'),e=a('<div class="as3cf-wizard-control-row as3cf-wizard-control-row-secondary"></div>'),f=b.strings.next_prefix+" ";return this.nextStep&&(f+=this.nextStep.data.title,d.append('<button class="button-primary" data-action-wizard="nextStep">'+(this.data.next_step_text||f)+"</button>")),this.isLast()&&d.append('<button class="button-primary" data-action-wizard="complete">'+(this.data.complete_setup_text||b.strings.complete_setup)+"</button>"),this.prevStep&&d.append('<a href="#" data-action-wizard="prevStep">'+b.strings.previous_step+"</a>"),this.index>0&&e.append('<div class="as3cf-step-progress wp-ui-text-icon">Step '+this.index+" of "+this.total+"</div>"),e.append('<a href="#" data-action-wizard="exit">'+b.strings.skip_to_settings+"</a>"),c.append(d,e),c},o.prototype.dataKey=function(){return"actionWizard"+this.slug[0].toUpperCase()+this.slug.substr(1)},o.prototype.actionProxy=function(b){var c=this;return function(d){var e=a(this),f=e.data(b),g=c[f];d.preventDefault(),"function"==typeof g?g.call(c):console.warn("The setup wizard for "+c.slug+' has no method "'+f+'"')}},o.prototype.bindToDataActions=function(){h.on("click","[data-action-wizard-"+this.slug+"]",this.actionProxy(this.dataKey())),this.$el.on("click","[data-action-wizard]",this.actionProxy("actionWizard")),this.$el.on("click","[data-action-wizard-goto-step]",function(b){var c=a(b.target).data("actionWizardGotoStep");b.preventDefault(),this.goToStep(this.getStepById(c))}.bind(this))},o.prototype.launch=function(a){"string"==typeof a&&(a=this.getStepById(a)),this.goToStep(a||this.steps.first()),this.display(),this.$el.trigger("as3cf.wizard.launched",[this])},o.prototype.display=function(){j.hide(),this.$el.show()},o.prototype.getStepById=function(a){return this.steps.findWhere({id:a})},o.prototype.goToStep=function(a){return a instanceof p?void(this.canChangeStep()&&(this.steps.each(function(b){b!==a&&b.$el.removeClass("active")}),this.currentStep=a,this.updateUrl(),a.$el.addClass("active"))):void console.warn("Invalid step",a)},o.prototype.canChangeStep=function(){var b=this;if(!this.currentStep)return!0;try{this.currentStep.$el.find("[data-as3cf-validate]").each(function(c,d){var e=a(d).data("as3cfValidate");e=_.isString(e)?e.split("|"):[],b.$el.trigger("as3cf.wizard.validate",[e,d,b])})}catch(c){return alert(c),!1}return!0},o.prototype.updateUrl=function(){var a={namespace:"as3cf.assetsPull",wizard:this.slug,step:this.currentStep?this.currentStep.id:null};if("function"==typeof history.pushState&&!_.isEqual(a,history.state)){var b,c=location.pathname,d=this.slug+"_setup_step";b=this.currentStep&&location.search.match("&"+d)?location.search.replace(new RegExp("\\b"+d+"=[^&#]+|$"),d+"="+this.currentStep.id):this.currentStep&&!location.search.match("&"+d)?location.search+"&"+d+"="+this.currentStep.id:location.search.replace(new RegExp("&?"+d+"=[^&#]+"),""),history.pushState(a,"",c+b+location.hash)}},o.prototype.nextStep=function(){this.currentStep.nextStep?this.goToStep(this.currentStep.nextStep):console.warn("No next step!")},o.prototype.prevStep=function(){this.currentStep.prevStep?this.goToStep(this.currentStep.prevStep):console.warn("No previous step!")},o.prototype.initDom=function(){var a=this.$el.addClass("as3cf-setup-wizard-"+this.slug).hide();this.steps.each(function(b){a.append(b.initEl())}),this.initImageFrame(),i.append(a)},o.prototype.initImageFrame=function(){var b=this.$imageFrame;this.$el.on("click","[data-wizard-step] img",function(){b.find("img").attr("src",this.src),b.addClass("active")}).append(b),b.on("click",function(){a(this).removeClass("active")})},o.prototype.complete=function(){i.find(".as3cf-wizard-complete-"+this.slug).length||(i.prepend(this.makeCompletedNotice()),h.trigger("wp-updates-notice-added")),this.exit(),this.$el.trigger("as3cf.wizardCompleted",[this]),this.$el.trigger("as3cf."+this.slug+"Wizard.completed",[this])},o.prototype.makeCompletedNotice=function(){return a('<div class="notice is-dismissible as3cf-updated updated inline show as3cf-wizard-complete"></div>').addClass("as3cf-wizard-complete-"+this.slug).html(a("<p></p>").text(b.wizard[this.slug].completed_message))},o.prototype.exit=function(){this.currentStep=null,this.updateUrl(),this.$el.hide(),j.show()},o.prototype.initSteps=function(a){var b=this;_.each(a,function(a){b.steps.push(new p(a,b.steps))})},g=new o("cloudfront"),h.on("as3cf.tabRendered",function(a,b){"assets_pull"===b&&n()}).one("as3cf.assetsPull.init",function(){g.init(),b.wizard.cloudfront.launch_on_load&&g.launch(b.wizard.cloudfront.launch_on_load),b.settings.domain&&b.settings.domain!==b.domain_status.domain&&d()}),g.$el.on("as3cf.wizard.launched",_.once(function(){g.$el.find('[name="domain"]').val(l||"assets."+location.hostname).trigger("change")})).on("as3cf.wizard.validate",function(c,d,f,g){var h=a(f);_.each(d,function(a){if("domain"===a&&!e(h.val()))throw b.strings.invalid_domain})}).on("change","[data-as3cf-setting]",function(b){var c=this,d=a(this),e=d.data("as3cfSetting");g.$el.find('[data-as3cf-setting="'+e+'"]').not(":input").not(c).text(d.val()),g.$el.trigger("as3cf.assetsPull.settingChanged",[e,d.val()])}).on("as3cf.assetsPull.settingChanged",function(a,b,c){var d,e;"domain"===b&&(l=c,e=c.split("."),d=e.length>2?e.shift():"@",i.find('[data-as3cf-setting="basedomain_ref"]').text(e.join(".")),i.find('[data-as3cf-setting="subdomain_ref"]').text(d))}),"function"==typeof document.execCommand&&i.addClass("as3cf-click-to-copy").on("click","[data-as3cf-copy]",function(){f(this),document.execCommand("copy"),window.getSelection().removeAllRanges()}),m.onpopstate=window.onpopstate,window.onpopstate=function(a){_.has(a.state,"step")&&_.isMatch(a.state,{wizard:"cloudfront",namespace:"as3cf.assetsPull"})&&g.launch(a.state.step),"function"==typeof m.onpopstate&&m.onpopstate.apply(this,arguments)},i.on("click","[data-action-as3cf-check-domain]",function(a){a.preventDefault(),e(k.val())?d():alert(b.strings.invalid_domain)}).on("as3cf.cloudfrontWizard.completed",function(){k.val(l),d({save_domain:!0})})}(jQuery,as3cf_assets_pull);