!function(a){function b(){_.chain(dbrains.plugins).map(function(a){return new d(a)}).invoke("init")}var c=a("#update-plugins-table,.wp-list-table.plugins"),d=function(a,b){this.data=a,this.parent=b,this.$check=c.find('.check-column [value="'+a.basename+'"]'),this.$row=this.$check.closest("tr"),this.$noticeContainer=null};d.prototype.checkAgainLink=function(){return' <a class="dbrains-check-my-licence-again" href="#">'+dbrains.strings.check_license_again+"</a>"},d.prototype.hasLicenseErrors=function(){var a=this.isAddon()?this.parent.data.license:this.data.license;return!_.isEmpty(a.errors)},d.prototype.disableUpdateCheckbox=function(){c.is("#update-plugins-table")&&this.$check.prop({disabled:!0,checked:!1})},d.prototype.enableUpdateCheckbox=function(){c.is("#update-plugins-table")&&this.$check.prop({disabled:!1})},d.prototype.setNotice=function(a){this.$noticeContainer.find(".as3cf-license-notice").remove(),this.$noticeContainer.append('<div class="as3cf-license-notice update-message notice inline notice-warning notice-alt"><p class="as3cf-before">'+a+this.checkAgainLink()+"</p></div>")},d.prototype.clearNotice=function(){var b=this,c=this.$noticeContainer.find(".as3cf-license-notice");a.when(c.fadeOut()).done(function(){c.remove(),b.$row.children().css("box-shadow",""),b.$noticeContainer.find(".update-message").show()})},d.prototype.render=function(){this.hasLicenseErrors()?(this.initNoticeContainer(),this.disableUpdateCheckbox(),this.$noticeContainer.find('.update-message:not(".as3cf-license-notice")').hide(),this.setNotice(this.getLicenseNotice())):this.$noticeContainer&&(this.enableUpdateCheckbox(),this.clearNotice()),this.isAddon()||_.invoke(this.addons,"render")},d.prototype.initNoticeContainer=function(){if(!this.$noticeContainer){if(c.is("#update-plugins-table"))this.$noticeContainer=this.$row.find(".plugin-title");else{var a=c.find('.plugin-update-tr[data-plugin="'+this.data.basename+'"]');a.length?this.$noticeContainer=a.find(".plugin-update"):(this.$row.after('<tr class="plugin-update-tr '+this.$row.attr("class")+'" id="'+this.data.slug+'-update" data-slug="'+this.data.slug+'" data-plugin="'+this.data.basename+'" ><td colspan="3" class="plugin-update colspanchange"></td></tr>'),this.$row.children().css("box-shadow","none"),this.$noticeContainer=c.find('.plugin-update-tr[data-plugin="'+this.data.basename+'"] .plugin-update'))}this.$noticeContainer.on("click",".dbrains-check-my-licence-again",_.bind(this.checkLicenseAgain,this))}},d.prototype.getLicenseNotice=function(){return this.isAddon()?dbrains.strings.requires_parent_license.replace("%s",this.parent.data.name):_.values(this.data.license.errors).join("")},d.prototype.checkLicenseAgain=function(b){var c=this,d=a(b.target),e=a('<span class="spinner is-active dbrains-licence-check-spinner" style="float:none; margin-top: -3px;"></span>');b.preventDefault(),d.hide().after(e),this.ajaxCheckLicense().done(function(a){c.isAddon()?(c.parent.data.license.errors=a.errors,c.parent.render()):(c.data.license.errors=a.errors,c.render())}).fail(function(){c.setNotice(dbrains.strings.license_check_problem)}).always(function(){e.remove()})},d.prototype.ajaxCheckLicense=function(){var b=this.isAddon()?this.parent.data.prefix:this.data.prefix;return a.ajax({url:ajaxurl,type:"POST",dataType:"json",cache:!1,data:{action:b+"_check_licence",nonce:dbrains.nonces.check_licence}})},d.prototype.init=function(){this.render(),this.isAddon()||this.initAddons()},d.prototype.isAddon=function(){return!!this.parent},d.prototype.initAddons=function(){var a=this;this.addons=_.map(this.data.addons,function(b){return new d(b,a)}),_.invoke(this.addons,"init")},c.length&&a(b)}(jQuery);