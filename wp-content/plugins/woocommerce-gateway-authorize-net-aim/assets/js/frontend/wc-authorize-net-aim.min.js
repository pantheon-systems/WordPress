/*
 WooCommerce Authorize.Net AIM Accept.js Handler
 Version 3.12.2

 Copyright (c) 2016, SkyVerge, Inc.
 Licensed under the GNU General Public License v3.0
 http://www.gnu.org/licenses/gpl-3.0.html
 */

(function() {
  var indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

  jQuery(document).ready(function($) {
    "use strict";
    window.WC_Authorize_Net_AIM_Accept_JS_Handler = (function() {
      function WC_Authorize_Net_AIM_Accept_JS_Handler() {
        this.params = window['wc_authorize_net_aim_params'];
        if (this.params === void 0) {
          return;
        }
        if (this.params.accept_js_enabled) {
          $(document.body).on('sv_wc_payment_form_valid_payment_data', (function(_this) {
            return function(event, data) {
              return _this.init(event, data);
            };
          })(this));
          $(document.body).on('checkout_error', function() {
            return $("input[name=wc-authorize-net-aim-payment-nonce]").val('');
          });
        }
      }

      WC_Authorize_Net_AIM_Accept_JS_Handler.prototype.init = function(event, data) {
        this.payment_form = data.payment_form;
        this.errors = [];
        if (this.payment_form.id !== 'authorize_net_aim') {
          return void 0;
        }
        if (!data.passed_validation) {
          return void 0;
        }
        if (!this.payment_form.payment_fields.find('input[name=wc-authorize-net-aim-payment-nonce]').length) {
          return true;
        }
        if (this.has_nonce()) {
          return true;
        }
        this.dispatch_card();
        return false;
      };

      WC_Authorize_Net_AIM_Accept_JS_Handler.prototype.dispatch_card = function() {
        var data;
        this.payment_form.block_ui();
        data = this.get_request_data();
        this.log_request(data);
        return Accept.dispatchData(data, (function(_this) {
          return function(response) {
            return _this.handle_response(response);
          };
        })(this));
      };

      WC_Authorize_Net_AIM_Accept_JS_Handler.prototype.get_request_data = function() {
        var csc, data, expiry;
        expiry = $.payment.cardExpiryVal($('input[name=wc-authorize-net-aim-expiry]').val());
        data = {
          authData: {
            clientKey: this.params.client_key,
            apiLoginID: this.params.login_id
          },
          cardData: {
            cardNumber: $('input[id=wc-authorize-net-aim-account-number]').val().replace(/-|\s/g, ''),
            month: expiry.month.toString(),
            year: expiry.year.toString()
          }
        };
        csc = this.payment_form.payment_fields.find('input[id=wc-authorize-net-aim-csc]').val();
        if ((csc != null) && this.payment_form.csc_required) {
          data.cardData.cardCode = csc;
        }
        return data;
      };

      WC_Authorize_Net_AIM_Accept_JS_Handler.prototype.handle_response = function(response) {
        var i, len, message, ref;
        this.log_response(response);
        if (response.messages.resultCode !== 'Error') {
          this.set_nonce(response.opaqueData.dataValue, response.opaqueData.dataDescriptor);
          return this.payment_form.form.submit();
        } else {
          ref = response.messages.message;
          for (i = 0, len = ref.length; i < len; i++) {
            message = ref[i];
            this.handle_error(message.code, message.text);
          }
          this.payment_form.render_errors(this.errors);
          return this.payment_form.unblock_ui();
        }
      };

      WC_Authorize_Net_AIM_Accept_JS_Handler.prototype.set_nonce = function(nonce, descriptor) {
        var card_number;
        $('input[name=wc-authorize-net-aim-payment-nonce]').val(nonce);
        $('input[name=wc-authorize-net-aim-payment-descriptor]').val(descriptor);
        card_number = $('input[id=wc-authorize-net-aim-account-number]').val();
        $('input[name=wc-authorize-net-aim-card-type]').val($.payment.cardType(card_number));
        return $('input[name=wc-authorize-net-aim-last-four]').val(card_number.slice(-4));
      };

      WC_Authorize_Net_AIM_Accept_JS_Handler.prototype.handle_error = function(code, message) {
        console.log('Authorize.Net AIM Error: ' + message + ' (' + code + ')');
        switch (code) {
          case 'E_WC_05':
            message = this.payment_form.params.card_number_invalid;
            break;
          case 'E_WC_06':
          case 'E_WC_07':
          case 'E_WC_08':
          case 'E00073':
            message = this.payment_form.params.card_exp_date_invalid;
            break;
          case 'E_WC_15':
            message = this.payment_form.params.cvv_length_invalid;
            break;
          default:
            message = this.params.general_error;
        }
        if (indexOf.call(this.errors, message) < 0) {
          return this.errors.push(message);
        }
      };

      WC_Authorize_Net_AIM_Accept_JS_Handler.prototype.has_nonce = function() {
        return $('input[name=wc-authorize-net-aim-payment-nonce]').val();
      };

      WC_Authorize_Net_AIM_Accept_JS_Handler.prototype.log_request = function(data) {
        var log_data;
        log_data = this.clone_log_data(data);
        if (log_data.cardData) {
          if (log_data.cardData.cardNumber) {
            log_data.cardData.cardNumber = log_data.cardData.cardNumber.replace(/\d(?=\d{4})/g, '*');
          }
          if (log_data.cardData.cardCode) {
            log_data.cardData.cardCode = log_data.cardData.cardCode.replace(/[0-9]/g, '*');
          }
        }
        return this.log_data(log_data, 'request');
      };

      WC_Authorize_Net_AIM_Accept_JS_Handler.prototype.log_response = function(data) {
        return this.log_data(data, 'response');
      };

      WC_Authorize_Net_AIM_Accept_JS_Handler.prototype.clone_log_data = function(data) {
        var key, log_data;
        if ((data == null) || typeof data !== 'object') {
          return data;
        }
        log_data = {};
        for (key in data) {
          log_data[key] = this.clone_log_data(data[key]);
        }
        return log_data;
      };

      WC_Authorize_Net_AIM_Accept_JS_Handler.prototype.log_data = function(data, type) {
        var ajax_data;
        if (!this.params.ajax_log) {
          return;
        }
        ajax_data = {
          'action': 'wc_' + this.payment_form.id + '_log_js_data',
          'security': this.params.ajax_log_nonce,
          'type': type,
          'data': data
        };
        return $.ajax({
          url: this.params.ajax_url,
          data: ajax_data
        });
      };

      return WC_Authorize_Net_AIM_Accept_JS_Handler;

    })();
    return window.wc_authorize_net_aim_accept_js_handler = new WC_Authorize_Net_AIM_Accept_JS_Handler();
  });

}).call(this);


